<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/client/admin/js/tableForm/tableForm.js - OpenVeo AngularJS back end</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo AngularJS back end</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 5.1.0
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/alertService.html">alertService</a></li>
                                <li><a href="../classes/applicationService.html">applicationService</a></li>
                                <li><a href="../classes/authenticationService.html">authenticationService</a></li>
                                <li><a href="../classes/entityService.html">entityService</a></li>
                                <li><a href="../classes/i18nService.html">i18nService</a></li>
                                <li><a href="../classes/menuService.html">menuService</a></li>
                                <li><a href="../classes/ovDateTimePicker.html">ovDateTimePicker</a></li>
                                <li><a href="../classes/OvDateTimePickerController.html">OvDateTimePickerController</a></li>
                                <li><a href="../classes/ovMatch.html">ovMatch</a></li>
                                <li><a href="../classes/ovMultiCheckBox.html">ovMultiCheckBox</a></li>
                                <li><a href="../classes/ovTags.html">ovTags</a></li>
                                <li><a href="../classes/OvUrlFactory.html">OvUrlFactory</a></li>
                                <li><a href="../classes/SocketFactory.html">SocketFactory</a></li>
                                <li><a href="../classes/storageProvider.html">storageProvider</a></li>
                                <li><a href="../classes/translateFilter.html">translateFilter</a></li>
                                <li><a href="../classes/truncateFilter.html">truncateFilter</a></li>
                                <li><a href="../classes/userService.html">userService</a></li>
                                <li><a href="../classes/utilService.html">utilService</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ov.html">ov</a></li>
                                <li><a href="../modules/ov.alert.html">ov.alert</a></li>
                                <li><a href="../modules/ov.authentication.html">ov.authentication</a></li>
                                <li><a href="../modules/ov.entity.html">ov.entity</a></li>
                                <li><a href="../modules/ov.i18n.html">ov.i18n</a></li>
                                <li><a href="../modules/ov.socket.html">ov.socket</a></li>
                                <li><a href="../modules/ov.storage.html">ov.storage</a></li>
                                <li><a href="../modules/ov.util.html">ov.util</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/client/admin/js/tableForm/tableForm.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

(function(angular) {

  var app = angular.module(&#x27;ov.tableForm&#x27;, [&#x27;ov.i18n&#x27;, &#x27;ngSanitize&#x27;]);

  /**
   * Defines a service reload Table.
   */
  function TableReloadEventService($rootScope) {
    var sharedService = {};

    // deliver a broadcast service to reload datatable
    sharedService.broadcast = function(callback) {
      $rootScope.$broadcast(&#x27;reloadDataTable&#x27;, {callback: callback});
    };
    return sharedService;
  }

  /**
   * Defines a DatePicker controller.
   */
  function DatePickerController() {
    var self = this;

    self.today = function() {
      self.dt = new Date();
    };
    self.today();

    self.clear = function() {
      self.dt = null;
    };

    self.toggleMax = function() {
      self.maxDate = self.maxDate ? null : new Date();
    };
    self.toggleMax();

    self.open = function() {
      self.status.opened = true;
    };

    self.dateOptions = {
      startingDay: 1
    };
    self.status = {
      opened: false
    };
  }

  /**
   * Defines a FormEditController.
   */
  function FormEditController($scope, $filter, entityService, tableReloadEventService) {

    var self = this;
    var type = $scope.editFormContainer.entityType || &#x27;&#x27;;
    var pluginName = $scope.editFormContainer.pluginName;

    // Formly form options
    // &quot;showForm&quot; property helps switching between edition and literals representation of fields
    this.options = {
      formState: {
        showForm: false
      }
    };

    // Force formly fields to execute their expressions when showForm changes
    // This will execute all hideExpressions
    $scope.$watch(&#x27;fec.options.formState.showForm&#x27;, function() {
      angular.forEach(self.fields, function(field) {
        field.runExpressions &amp;&amp; field.runExpressions();
      });
    }, true);

    // Reset form model when the scope is destroyed
    $scope.$on(&#x27;$destroy&#x27;, function() {
      self.cancelForm();
    });

    // init the form on a row
    this.init = function(row) {
      self.model = row;

      // Call init function if defined to set up dynamically some fields
      if ($scope.editFormContainer.init)
        $scope.editFormContainer.init(row);

      self.fields = $scope.editFormContainer.fields;
    };

    // Condition on a row to be edited
    this.conditionEditDetail = $scope.editFormContainer.conditionEditDetail || function() {
      return true;
    };

    this.updateRowBeforeEdit = function(tableRow, lastValueInDb) {
      if ($scope.editFormContainer.updateRowObjectBeforeEdit)
        $scope.editFormContainer.updateRowObjectBeforeEdit(tableRow, lastValueInDb);
      var cacheMustBeDeleted = false;
      for (var attrname in lastValueInDb) {
        if (tableRow[attrname] &amp;&amp; typeof tableRow[attrname] !== &#x27;object&#x27; &amp;&amp;
                tableRow[attrname] != lastValueInDb[attrname]) {
          cacheMustBeDeleted = true;
          tableRow[attrname] = lastValueInDb[attrname];
        }
      }

      // return if cache need to be deleted (true if any value is change between TableRow and lastValueInDb
      return cacheMustBeDeleted;
    };

    var oldEditModel;

    // When submit the form
    this.onSubmit = function() {
      self.model.saving = true;

      // Call submit function must return Promises
      $scope.editFormContainer.onSubmit(self.model).then(function() {

        // on success
        // save value in the fields as initial value

        try {
          self.options.updateInitialValue();
        } catch (error) {

          // &quot;updateInitialValue&quot; may fail due to a bug in angularjs-formly:
          // fields not visible due to &quot;hideExpression&quot; are not properly
          // initialized making &quot;updateInitialValue&quot; crash

        }
        self.model.saving = false;
        self.options.formState.showForm = false;
        tableReloadEventService.broadcast();
      }, function() {

        // on error
        // reset the form
        self.options.resetModel();
        self.model.saving = false;
        self.model = oldEditModel;
      });
    };

    // Toggle between show and editable information
    this.editForm = function() {
      oldEditModel = angular.copy(self.model);
      entityService.getEntity(type, pluginName, self.model.id).then(function(response) {
        if (response.data.entity) {
          var lastValue = response.data.entity;
          var cacheMustBeDeleted = self.updateRowBeforeEdit(self.model, lastValue);

          if (cacheMustBeDeleted) {
            $scope.$emit(&#x27;setAlert&#x27;, &#x27;warning&#x27;, $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.WARNING_ENTITY_MODIFIED&#x27;), 8000);
            entityService.deleteCache(type, pluginName);
          }
        } else {
          entityService.deleteCache(type, pluginName);
          $scope.$emit(&#x27;setAlert&#x27;, &#x27;danger&#x27;, $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.WARNING_ENTITY_DELETED&#x27;), 8000);
          tableReloadEventService.broadcast();
          return;
        }
        $scope.editFormContainer.pendingEdition = true;
        self.options.formState.showForm = true;
      });
    };

    this.cancelForm = function() {
      $scope.editFormContainer.pendingEdition = false;
      if (!self.options.formState)
        self.options.formState = {};

      self.options.formState.showForm = false;

      self.options.resetModel();
      self.model = oldEditModel;
    };
  }

  /**
   * Defines a FormAddController.
   */
  function FormAddController($scope, $filter, tableReloadEventService) {
    var self = this;
    this.model = $scope.addFormContainer.model;
    this.fields = $scope.addFormContainer.fields;
    this.isAddButtonDisabled = false;

    this.onSubmit = function() {
      self.isAddButtonDisabled = true;

      // Call submit function must return Promises
      $scope.addFormContainer.onSubmit(self.model).then(function() {

        // on success
        // reset the form
        self.options.resetModel();

        // Reload the table
        tableReloadEventService.broadcast();

        // Emit a success message
        $scope.$emit(&#x27;setAlert&#x27;, &#x27;success&#x27;, $filter(&#x27;translate&#x27;)(&#x27;CORE.UI.SAVE_SUCCESS&#x27;), 4000);

        self.isAddButtonDisabled = false;
      }, function() {
        self.isAddButtonDisabled = false;
      });
    };
    this.options = {};
  }

  /**
   * Defines a DataTableController.
   */
  function DataTableController($scope, $uibModal, entityService, $q) {
    var self = this;

    // All data
    this.rows = $scope.tableContainer.rows || {};

    // Entity to call
    this.entityType = $scope.tableContainer.entityType || &#x27;&#x27;;

    // Filter key list
    this.filterBy = angular.copy($scope.tableContainer.filterBy);

    // Header list
    this.header = $scope.tableContainer.header || [];

    // action object to display in le actions list
    this.actions = $scope.tableContainer.actions || [];

    // Column unsortable
    this.notSortBy = ($scope.tableContainer.init ? $scope.tableContainer.init.notSortBy : []).concat([&#x27;action&#x27;]);

    this.conditionToggleDetail = $scope.editFormContainer.conditionToggleDetail || function() {
      return true;
    };

    // hide selected checkbox
    this.showSelectAll = $scope.tableContainer.showSelectAll || true;

    // is a row selected
    this.isRowSelected = false;

    // Init Datatable
    this.init = {
      count: 10,
      page: 1,
      sortBy: $scope.tableContainer.init ? $scope.tableContainer.init.sortBy : this.header[0][&#x27;key&#x27;],
      sortOrder: $scope.tableContainer.init ? $scope.tableContainer.init.sortOrder : &#x27;asc&#x27;,
      filterBase: false
    };

    this.customTheme = {
      iconUp: &#x27;glyphicon glyphicon-triangle-bottom&#x27;,
      iconDown: &#x27;glyphicon glyphicon-triangle-top&#x27;,
      listItemsPerPage: [5, 10, 20, 30],
      itemsPerPage: 10,
      loadOnInit: true,
      cellTheme: $scope.tableContainer.cellTheme
    };

    // Enable selectAll option
    if (this.showSelectAll)
      this.customTheme[&#x27;templateHeadUrl&#x27;] = &#x27;views/elements/head.html&#x27;;

    // Pagination template
    this.customTheme[&#x27;templateUrl&#x27;] = &#x27;views/elements/pagination.html&#x27;;

    // The name of the plugin the entity belongs to
    var pluginName = $scope.tableContainer.pluginName;

    // Promise that cancel $http
    var canceller = $q.defer();

    // Array of callback to execute on reload success
    var callbackArrayOnReload = [];

    // callback to load Resource on filter, pagination or sort change
    this.getResource = function(params, paramsObj) {
      var param = {};

      if (canceller) {

        // Hack to differentiate cancel from server not repond on HttpInterceptor
        canceller.promise.status = true;
        canceller.resolve();
      }
      canceller = $q.defer();

      // Build query parameters
      var query = [];
      param[&#x27;limit&#x27;] = paramsObj.count;
      param[&#x27;page&#x27;] = Math.max(paramsObj.page - 1, 0);
      param[&#x27;sortBy&#x27;] = paramsObj.sortBy;
      param[&#x27;sortOrder&#x27;] = paramsObj.sortOrder === &#x27;dsc&#x27; ? &#x27;desc&#x27; : &#x27;asc&#x27;;

      self.filterBy.forEach(function(filter) {
        if (filter.value &amp;&amp; filter.value != &#x27;&#x27;) {
          switch (filter.type) {
            case &#x27;date&#x27;:
              var date = new Date(filter.value);

              if (filter.param === &#x27;date&#x27;) {
                var datePlus = new Date(date);
                datePlus.setDate(date.getDate() + 1);

                param[&#x27;dateStart&#x27;] = date.getTime();
                param[&#x27;dateEnd&#x27;] = datePlus.getTime();
              } else if (filter.param === &#x27;dateStart&#x27;)
                param[&#x27;dateStart&#x27;] = date.getTime();
              else if (filter.param === &#x27;dateEnd&#x27;) {
                date.setDate(date.getDate() + 1);
                date.setMilliseconds(date.getMilliseconds() - 1);
                param[&#x27;dateEnd&#x27;] = date.getTime();
              }
              break;
            case &#x27;select&#x27;:
              var values = [filter.value];
              if (filter.filterWithChildren) {
                for (var i = 0; i &lt; filter.options.length; i++) {
                  if (filter.options[i].value === filter.value) {
                    if (filter.options[i].children !== &#x27;&#x27;)
                      values = values.concat(filter.options[i].children.split(&#x27;,&#x27;));
                    break;
                  }
                }
              }

              param[filter.param] = values;
              break;
            default:
              query.push(filter.value);
              break;
          }
        }
      });

      if (query.length)
        param[&#x27;query&#x27;] = query.join(&#x27; &#x27;);

      // call entities that match params
      return entityService.getEntities(self.entityType, pluginName, param, canceller.promise).then(function(response) {
        self.rows = response.data.entities;
        self.selectAll = false;
        self.isRowSelected = false;
        response.data.pagination.page++;

        // Execute callback array
        if (callbackArrayOnReload.length) {
          for (var i = 0; i &lt; callbackArrayOnReload.length; i++) {
            callbackArrayOnReload[i]();
          }
          callbackArrayOnReload = [];
        }

        return {
          rows: self.rows,
          header: self.header,
          pagination: response.data.pagination
        };
      }, function(reject) {
        return {};
      });
    };

    // function to toggle detail
    this.toggleRowDetails = function(row) {
      if (self.conditionToggleDetail(row))
        angular.forEach(self.rows, function(value) {
          value.opened = (value.id === row.id) ? !value.opened : false;
          $scope.editFormContainer.pendingEdition = false;
        });
    };

    // function to call manually to reload dataTable
    this.reloadCallback = function() {
      self.selectAll = false;
    };

    // Broadcast listner to reload dataTable (on add row for exemple)
    $scope.$on(&#x27;reloadDataTable&#x27;, function(e, arg) {
      if (arg.callback) callbackArrayOnReload.push(arg.callback);
      self.reloadCallback();
    });

    this.commonActionExist = false;

    // call to check all unlocked selection checkbox
    this.checkAll = function() {
      self.commonActionExist = false;
      angular.forEach(self.rows, function(row) {
        row.selected = self.selectAll;
      });
      self.isRowSelected = self.selectAll;
    };

    /**
     * Checks / unchecks a table row.
     *
     * @method check
     */
    this.check = function() {
      var allChecked = true;
      self.isRowSelected = false;
      self.commonActionExist = false;

      // Check if at least one row is selected and if all rows are selected or not
      angular.forEach(self.rows, function(row) {
        if (row.selected)
          self.isRowSelected = true;
        else
          allChecked = false;
      });

      self.selectAll = allChecked;
    };

    // Verify if an action is enable for all selected row
    this.verifyCondition = function(action) {
      var enable = true;
      for (var i = 0; i &lt; self.rows.length &amp;&amp; enable; i++) {
        var row = self.rows[i];
        if (row.selected) {
          var condition = !action.condition || action.condition(row);
          enable = enable &amp;&amp; action.global &amp;&amp; condition;
        }
      }
      self.commonActionExist = self.commonActionExist || enable;
      return enable;
    };

    // Execute an action on row after calling a popup verifying and reload table
    this.prepareSingleAction = function(action, row) {
      if (action.warningPopup)
        self.openModal(action.callback, row);
      else {
        action.callback(row, self.reloadCallback);
      }
    };

    // Execute an action on all selected row after calling a popup verifying
    this.executeGlobalAction = function(action) {
      var selected = self.getSelectedId();
      self.openModal(action.global, selected);
    };

    // Get All selected row id
    this.getSelectedId = function() {
      var selected = [];
      for (var i = 0; i &lt; self.rows.length; i++) {
        var row = self.rows[i];
        if (row.selected)
          selected.push(row.id);
      }
      return selected;
    };

    // Open a modal, apply callback on OK promise and reload datatable
    this.openModal = function(action, item) {

      var modalInstance = $uibModal.open({
        templateUrl: &#x27;tableModal.html&#x27;,
        controller: &#x27;ModalInstanceTableController&#x27;
      });

      modalInstance.result.then(function() {
        action(item, self.reloadCallback);
      }, function() {

        // Do nothing

      });
    };
  }

  /**
   * Defines a modal instance for all modals related to the table form.
   */
  function ModalInstanceTableController($scope, $uibModalInstance) {
    $scope.ok = function() {
      $uibModalInstance.close(true);
    };

    $scope.cancel = function() {
      $uibModalInstance.dismiss(&#x27;cancel&#x27;);
    };
  }

  app.controller(&#x27;DataTableController&#x27;, DataTableController);
  app.controller(&#x27;FormEditController&#x27;, FormEditController);
  app.controller(&#x27;FormAddController&#x27;, FormAddController);
  app.controller(&#x27;ModalInstanceTableController&#x27;, ModalInstanceTableController);
  app.controller(&#x27;DatePickerController&#x27;, DatePickerController);
  app.factory(&#x27;tableReloadEventService&#x27;, TableReloadEventService);

  // Controller for table, form in table and form outside table
  DataTableController.$inject = [&#x27;$scope&#x27;, &#x27;$uibModal&#x27;, &#x27;entityService&#x27;, &#x27;$q&#x27;];
  FormEditController.$inject = [&#x27;$scope&#x27;, &#x27;$filter&#x27;, &#x27;entityService&#x27;, &#x27;tableReloadEventService&#x27;];
  FormAddController.$inject = [&#x27;$scope&#x27;, &#x27;$filter&#x27;, &#x27;tableReloadEventService&#x27;];
  ModalInstanceTableController.$inject = [&#x27;$scope&#x27;, &#x27;$uibModalInstance&#x27;];
  DatePickerController.$inject = [&#x27;$scope&#x27;];

  // Service to reload a displayed table
  TableReloadEventService.$inject = [&#x27;$rootScope&#x27;];

})(angular);

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
