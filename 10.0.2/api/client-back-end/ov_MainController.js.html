<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ov/MainController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ov/MainController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

(function(app) {

  /**
   * Defines the main controller parent of all controllers in the
   * application. All actions not handled in partials are handled
   * by the main controller.
   */
  function MainController($rootScope,
    $scope,
    $location,
    $route,
    authenticationService,
    menuService,
    applicationService,
    userService,
    i18nService,
    alertService,
    entityService,
    $window,
    $q
  ) {

    $scope.displayMainMenu = false;
    $scope.isResponsiveMenuClosed = true;
    $scope.languages = i18nService.getLanguages();
    $scope.language = i18nService.getLanguageName(i18nService.getLanguage());
    $scope.indexOpen = -1;
    $scope.menuDropdownIsOpen = false;

    /**
     * Logs out the user.
     *
     * Remove user information, remove all admin informations
     * and broadcast a loggedOut event to children controllers.
     */
    function logout() {
      $scope.closeResponsiveMenu();
      authenticationService.setUserInfo();
      $scope.menu = false;
      $scope.displayMainMenu = false;
      menuService.destroyMenu();
      i18nService.removeDictionary('back-office');
      applicationService.destroy();
      userService.destroy();
      entityService.deleteCache();
      alertService.closeAll();
      $location.path('/login');
    }

    /**
     * Replaces placeholders by corresponding values in the given string.
     * Function copied from AngularJS ngRoute.
     *
     * @param {string} string A string containing placeholders
     * @param {string} params An array of parameters
     * @return {string} interpolation of the redirect path with the parameters
     */
    function interpolate(string, params) {
      var result = [];
      angular.forEach((string || '').split(':'), function(segment, i) {
        if (i === 0) {
          result.push(segment);
        } else {
          var segmentMatch = segment.match(/(\w+)(?:[?*])?(.*)/);
          var key = segmentMatch[1];
          result.push(params[key]);
          result.push(segmentMatch[2] || '');
          delete params[key];
        }
      });
      return result.join('');
    }

    /**
     * Replaces placeholders by corresponding values in the given string.
     *
     * @param {string} string A string containing placeholders
     * @param {string} params An array of parameters
     * @return {string} The compiled string
     */
    function resolvePath(string, params) {
      params = angular.copy(params);

      if (params &amp;&amp; Object.keys(params).length)
        return interpolate(string, params);
      else
        return string;
    }

    /**
     * Gets permissions from groups for the given operation.
     *
     * @param {Array} groupIds A list of group ids
     * @param {String} operation "get", "update" or "delete"
     * @return {Array} The list of permissions
     */
    function getPermissionsFromGroups(groupIds, operation) {
      var permissions = [];

      if (groupIds &amp;&amp; groupIds.length) {
        groupIds.forEach(function(groupId) {
          permissions.push(operation + '-group-' + groupId);
        });
      }

      return permissions;
    }

    $scope.toggleResponsiveMenu = function() {
      $scope.isResponsiveMenuClosed = !$scope.isResponsiveMenuClosed;
    };

    $scope.closeResponsiveMenu = function() {
      if (!$scope.isResponsiveMenuClosed &amp;&amp; $scope.displayMainMenu)
        $scope.isResponsiveMenuClosed = true;
    };

    $scope.openResponsiveMenu = function() {
      if ($scope.isResponsiveMenuClosed &amp;&amp; $scope.displayMainMenu)
        $scope.isResponsiveMenuClosed = false;
    };

    $scope.navigate = function(event) {
      if (event) {
        $scope.closeResponsiveMenu();
        $location.path(angular.element(event.currentTarget).attr('href'));
      }
    };

    /**
     * Changes the language to the given one.
     *
     * This will reload the page due to the main menu which can't be
     * reloaded.
     *
     * @param {String} language The new language code (e.g. fr_FR)
     */
    $scope.changeLanguage = function(language) {
      i18nService.setLanguage(language);
      $window.location.reload();
    };

    $scope.toggleSidebarSubMenu = function(id) {
      if ($scope.indexOpen == -1)
        $scope.indexOpen = id;
      else if ($scope.indexOpen == id)
        $scope.indexOpen = -1;
      else
        $scope.indexOpen = id;
    };

    /**
     * Logs out the actual user.
     *
     * If authentication was made on an external service such as CAS, user is redirected to
     * the external service page.
     * If authentication was made using an internal service such as LDAP (or local),
     * logout is performed without reloading the page.
     */
    $scope.logout = function() {
      if ($scope.userInfo &amp;&amp; $scope.userInfo.origin === openVeoSettings.authenticationStrategies.CAS)
        $window.location.href = 'logout';
      else
        authenticationService.logout().then(logout, logout);
    };

    // Listen to alert add
    $scope.$on('setAlert', function(event, type, msg, timeout) {
      alertService.add(type, msg, timeout);
    });

    // Listen to logout request event to logout the user
    $scope.$on('logout', function() {
      $scope.logout();
    });

    // Listen to forceLogout request event to logout the user
    // without making a call to the server
    $scope.$on('forceLogout', function() {
      logout();
    });

    // Listen to angular router change start event
    // Some promises, like translations and back end menu must be retrieved
    // before routing to an authenticated page
    // Also check if the user is authenticated to grant him access to an authenticated page.
    $scope.$on('$routeChangeStart', function(event, route) {
      var expectedParams = route.params;
      var expectedPath = resolvePath(route.originalPath, expectedParams);

      // No destination route, nothing to do
      if (!expectedPath)
        return false;

      // Retrieve user information and back end translations
      var userInfo = authenticationService.getUserInfo();
      var translations = i18nService.getDictionary('back-office', i18nService.getLanguage());

      if ($location.path() !== '/login' &amp;&amp; userInfo &amp;&amp; (!menuService.getMenu() || !translations)) {

        // User has access to the back end
        // Some promises are required to access the back end
        // Prevent router from routing to the specified destination and retrieve promises first

        event.preventDefault();

        // List of promises required to access an authenticated page
        var initPromises = {
          i18nCommon: i18nService.addDictionary('common'),
          i18nBE: i18nService.addDictionary('back-office', true),
          menu: menuService.loadMenu()
        };

        $q.all(initPromises).then(
          function(values) {

            // Got enough information to display the back end
            // Just resume the route
            if (expectedPath === resolvePath($location.path(), expectedParams))
              $route.reload();
            else
              $location.path(expectedPath);

          },
          function(error) {

            // User is not authorized to access the back end page
            // It means that its session has expired
            // Cleanly logout the user
            if (error.status === 401) {
              logout();
              $route.reload();
            }

          }
        );

        return false;
      } else if ($location.path() !== '/login' &amp;&amp; !userInfo) {

        // User is not authenticated and tries to access the back end
        // Redirect to login page

        event.preventDefault();
        $location.path('/login');
        return false;
      } else if ($location.path() !== '/login' &amp;&amp; userInfo) {

        // User is authenticated and tries to access a back end page

        // Check if user has access to the expected page
        $scope.userInfo = userInfo;
        if (route.access &amp;&amp; !$scope.checkAccess(route.access)) {
          event.preventDefault();
          $location.path('/');
          return false;
        }

      } else if ($location.path() === '/login' &amp;&amp; userInfo) {
        event.preventDefault();
        $location.path('/');
        return false;
      }

    });

    // Listen to route change success event to
    // set new page title and offers access to the menu if
    // user is authenticated
    $scope.$on('$routeChangeSuccess', function(event, route) {
      entityService.deleteCache();
      $scope.userInfo = authenticationService.getUserInfo();
      if ($scope.userInfo) {
        $scope.menu = menuService.getMenu();
        $scope.displayMainMenu = ($scope.menu) ? true : false;
        menuService.setActiveMenuItem();
      } else
        $scope.displayMainMenu = false;

      // Change page title
      $scope.title = $route.current &amp;&amp; $route.current.title || '';

    });

    // Listen to the route change error event
    // If user is not authenticated, redirect to the login page
    // otherwise redirect to the home page
    $scope.$on('$routeChangeError', function(event, current, previous, eventObj) {
      if (!$scope.userInfo)
        $location.path('/login');
      else if (eventObj &amp;&amp; eventObj.redirect)
        $location.path(eventObj.redirect);
      else $location.path('/');
    });

    /**
     * Checks that authenticated user has a permission.
     *
     * @param {Array|String} permissions One or several permissions
     * @return {Boolean} true if user has one of the permissions, false otherwise
     */
    $scope.checkAccess = function(permissions) {
      if ($scope.userInfo) {

        // Access granted to admin
        if ($scope.userInfo.id === openVeoSettings.superAdminId) return true;

        if (typeof permissions === 'string')
          permissions = [permissions];

        // Access granted to user with roles and with the right permissions
        if ($scope.userInfo.roles &amp;&amp; $scope.userInfo.roles.length != 0 &amp;&amp;
                $scope.userInfo.permissions &amp;&amp; $scope.userInfo.permissions.length != 0) {
          return permissions.filter(function(permission) {
            return $scope.userInfo.permissions.indexOf(permission) >= 0;
          }).length > 0;
        }

      }

      return false;
    };

    /**
     * Checks that user has permission to access a content.
     *
     * @param {Object} content The content entity to try to access
     * @param {String} operation The operation that will be performed on the content
     * @return {Boolean} true if user has sufficient permission to perform the operation on the content
     */
    $scope.checkContentAccess = function(content, operation) {
      if ($scope.userInfo &amp;&amp; content &amp;&amp; operation) {

        // Access granted to super administrator and owner
        // Access is also granted for contents belonging to the anonymous user
        if ($scope.userInfo.id === openVeoSettings.superAdminId ||
            content.metadata.user === openVeoSettings.anonymousId ||
            $scope.userInfo.id === content.metadata.user
        ) return true;

        // Access granted to users belonging to, at least, one of the groups associated to the content
        // User must have group permission on the operation
        if (content.metadata.groups &amp;&amp; content.metadata.groups.length) {
          var contentPermissions = getPermissionsFromGroups(content.metadata.groups, operation);

          for (var i = 0; i &lt; contentPermissions.length; i++) {
            if ($scope.userInfo.permissions.indexOf(contentPermissions[i]) >= 0)
              return true;
          }

        }
      }

      return false;
    };

    /**
     * Checks that user possesses a permission.
     *
     * @param {String} permission The permission id
     * @return {Boolean} true if user has the permission
     */
    $scope.hasPermission = function(permission) {
      if ($scope.userInfo &amp;&amp; $scope.userInfo.permissions &amp;&amp; permission)
        return $scope.userInfo.permissions.indexOf(permission) >= 0;

      return false;
    };

  }

  app.controller('MainController', MainController);
  MainController.$inject = [
    '$rootScope',
    '$scope',
    '$location',
    '$route',
    'authenticationService',
    'menuService',
    'applicationService',
    'userService',
    'i18nService',
    'alertService',
    'entityService',
    '$window',
    '$q'
  ];

})(angular.module('ov'));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ov.html">ov</a></li><li><a href="module-ov_alert.html">ov/alert</a></li><li><a href="module-ov_authentication.html">ov/authentication</a></li><li><a href="module-ov_entity.html">ov/entity</a></li><li><a href="module-ov_i18n.html">ov/i18n</a></li><li><a href="module-ov_socket.html">ov/socket</a></li><li><a href="module-ov_storage.html">ov/storage</a></li><li><a href="module-ov_util.html">ov/util</a></li></ul><h3>Classes</h3><ul><li><a href="module-ov_alert-AlertService.html">ov/alert~AlertService</a></li><li><a href="module-ov_authentication-AuthenticationService.html">ov/authentication~AuthenticationService</a></li><li><a href="module-ov_entity-EntityService.html">ov/entity~EntityService</a></li><li><a href="module-ov_i18n-I18nService.html">ov/i18n~I18nService</a></li><li><a href="module-ov_i18n-TranslateFilter.html">ov/i18n~TranslateFilter</a></li><li><a href="module-ov_socket-SocketFactory.html">ov/socket~SocketFactory</a></li><li><a href="module-ov_storage-StorageProvider.html">ov/storage~StorageProvider</a></li><li><a href="module-ov_util-OvUrlFactory.html">ov/util~OvUrlFactory</a></li><li><a href="module-ov_util-UtilService.html">ov/util~UtilService</a></li><li><a href="module-ov-ApplicationService.html">ov~ApplicationService</a></li><li><a href="module-ov-ErrorInterceptor.html">ov~ErrorInterceptor</a></li><li><a href="module-ov-MenuService.html">ov~MenuService</a></li><li><a href="module-ov-ovAutoComplete.html">ov~ovAutoComplete</a></li><li><a href="module-ov-ovDateTimePicker.html">ov~ovDateTimePicker</a></li><li><a href="module-ov-ovMatch.html">ov~ovMatch</a></li><li><a href="module-ov-ovMultiCheckBox.html">ov~ovMultiCheckBox</a></li><li><a href="module-ov-ovTags.html">ov~ovTags</a></li><li><a href="module-ov-TruncateFilter.html">ov~TruncateFilter</a></li><li><a href="module-ov-userService.html">ov~userService</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Mon Apr 04 2022 12:31:47 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
