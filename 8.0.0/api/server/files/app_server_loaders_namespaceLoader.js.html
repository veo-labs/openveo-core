<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>app/server/loaders/namespaceLoader.js - OpenVeo Core server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">OpenVeo Core server</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 8.0.0
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/accessToken.html">accessToken</a></li>
                                <li><a href="../classes/api.html">api</a></li>
                                <li><a href="../classes/ApplicationController.html">ApplicationController</a></li>
                                <li><a href="../classes/ApplicationServer.html">ApplicationServer</a></li>
                                <li><a href="../classes/authenticationController.html">authenticationController</a></li>
                                <li><a href="../classes/authenticator.html">authenticator</a></li>
                                <li><a href="../classes/client.html">client</a></li>
                                <li><a href="../classes/ClientProvider.html">ClientProvider</a></li>
                                <li><a href="../classes/CORE_HOOKS.html">CORE_HOOKS</a></li>
                                <li><a href="../classes/CorePlugin.html">CorePlugin</a></li>
                                <li><a href="../classes/CorePluginApi.html">CorePluginApi</a></li>
                                <li><a href="../classes/DefaultController.html">DefaultController</a></li>
                                <li><a href="../classes/entityLoader.html">entityLoader</a></li>
                                <li><a href="../classes/ErrorController.html">ErrorController</a></li>
                                <li><a href="../classes/GroupController.html">GroupController</a></li>
                                <li><a href="../classes/GroupProvider.html">GroupProvider</a></li>
                                <li><a href="../classes/HTTP_ERRORS.html">HTTP_ERRORS</a></li>
                                <li><a href="../classes/I18nController.html">I18nController</a></li>
                                <li><a href="../classes/listener.html">listener</a></li>
                                <li><a href="../classes/MenuController.html">MenuController</a></li>
                                <li><a href="../classes/migrationLoader.html">migrationLoader</a></li>
                                <li><a href="../classes/migrationProcess.html">migrationProcess</a></li>
                                <li><a href="../classes/namespaceLoader.html">namespaceLoader</a></li>
                                <li><a href="../classes/OauthController.html">OauthController</a></li>
                                <li><a href="../classes/path.html">path</a></li>
                                <li><a href="../classes/permissionLoader.html">permissionLoader</a></li>
                                <li><a href="../classes/pluginLoader.html">pluginLoader</a></li>
                                <li><a href="../classes/RoleController.html">RoleController</a></li>
                                <li><a href="../classes/RoleProvider.html">RoleProvider</a></li>
                                <li><a href="../classes/routeLoader.html">routeLoader</a></li>
                                <li><a href="../classes/Server.html">Server</a></li>
                                <li><a href="../classes/SettingProvider.html">SettingProvider</a></li>
                                <li><a href="../classes/SettingsController.html">SettingsController</a></li>
                                <li><a href="../classes/storage.html">storage</a></li>
                                <li><a href="../classes/TaxonomyController.html">TaxonomyController</a></li>
                                <li><a href="../classes/TaxonomyProvider.html">TaxonomyProvider</a></li>
                                <li><a href="../classes/TokenProvider.html">TokenProvider</a></li>
                                <li><a href="../classes/UserController.html">UserController</a></li>
                                <li><a href="../classes/UserProvider.html">UserProvider</a></li>
                                <li><a href="../classes/WebServiceServer.html">WebServiceServer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/core.html">core</a></li>
                                <li><a href="../modules/core-controllers.html">core-controllers</a></li>
                                <li><a href="../modules/core-loaders.html">core-loaders</a></li>
                                <li><a href="../modules/core-migration.html">core-migration</a></li>
                                <li><a href="../modules/core-oauth.html">core-oauth</a></li>
                                <li><a href="../modules/core-plugin.html">core-plugin</a></li>
                                <li><a href="../modules/core-providers.html">core-providers</a></li>
                                <li><a href="../modules/core-servers.html">core-servers</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/server/loaders/namespaceLoader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * @module core-loaders
 */

/**
 * Provides functions to load namespaces from core and plugins configuration.
 *
 * @class namespaceLoader
 * @static
 */

var path = require(&#x27;path&#x27;);
var openVeoApi = require(&#x27;@openveo/api&#x27;);

/**
 * The list of socket controllers path with associated controller instance.
 *
 * It is used to instantiate each controller only once.
 *
 * @property controllers
 * @type Object
 * @private
 * @static
 */
var controllers = {};

/**
 * Attaches handlers to namespace.
 *
 * @example
 *     var namespaceLoader = process.require(&#x27;app/server/loaders/namespaceLoader.js&#x27;);
 *     var messagesDescriptors = {
 *       test1: &#x27;app/server/controllers/TestSocketController.test1Action&#x27;,
 *       test2: &#x27;app/server/controllers/TestSocketController.test2Action&#x27;
 *     };
 *
 *     namespaceLoader.addHandlers(namespace, messagesDescriptors, &#x27;/home/openveo/node_modules/openveo-plugin&#x27;);
 *
 * @method addHandlers
 * @static
 * @param {SocketNamespace} namespace The socket namespace
 * @param {Object} messagesDescriptors A list of socket namespace messages with associated controller / action
 * @param {String} pluginPath The root path of the plugin associated to the namespace used to find controllers
 * associated to messages
 */
module.exports.addHandlers = function(namespace, messagesDescriptors, pluginPath) {
  var messages = {};

  // Handle event when a client connects to the socket server
  namespace.on(&#x27;connection&#x27;, function(socket) {
    var socketInfo = {socketId: socket.id, ip: socket.handshake.address};
    process.logger.silly(&#x27;Socket client connected&#x27;, socketInfo);

    // Call action associated to &quot;connection&quot; message
    if (messages[&#x27;connection&#x27;]) messages[&#x27;connection&#x27;](socket);

    // Handle event when a client has been disconnected from the socket server
    socket.on(&#x27;disconnect&#x27;, function(callback) {
      process.logger.silly(&#x27;Socket client disconnected&#x27;, socketInfo);

      // Call action associated to &quot;disconnect&quot; message
      if (messages[&#x27;disconnect&#x27;]) messages[&#x27;disconnect&#x27;](socket, callback);

    });

    // Handle event when an error occurred between client and socket server
    socket.on(&#x27;error&#x27;, function(error, callback) {
      process.logger.silly(&#x27;Socket client error&#x27;, socketInfo);

      // Call action associated to &quot;error&quot; message
      if (messages[&#x27;error&#x27;]) messages[&#x27;error&#x27;](error, socket, callback);

    });

    // Handle custom socket messages
    for (var id in messages) {
      (function(id) {
        if (id === &#x27;connection&#x27; || id === &#x27;disconnect&#x27; || id === &#x27;error&#x27;)
          return;

        socket.on(id, function(data, callback) {
          process.logger.silly(&#x27;Socket client message &quot;&#x27; + id + &#x27;&quot;&#x27;, socketInfo);
          messages[id](data, socket, function(data) {
            callback &amp;&amp; callback(data);
          });
        });
      }(id));
    }
  });

  for (var message in messagesDescriptors) {
    var action = messagesDescriptors[message];

    // e.g. app/server/controllers/TestController.test1Action
    // becomes [&#x27;app/server/controllers/TestController&#x27;, &#x27;test1Action&#x27;]
    var actionChunks = action.split(&#x27;.&#x27;);

    // Got a message name and an action for this message
    if (message &amp;&amp; actionChunks.length === 2) {
      try {

        // Try to register the controller
        var controllerFilePath = path.join(pluginPath, actionChunks[0] + &#x27;.js&#x27;);
        var controllerInstance;

        if (controllers[controllerFilePath]) {

          // Controller instance already in cache
          controllerInstance = controllers[controllerFilePath];

        } else {

          // Controller has not been instantiated yet
          // Create an instance of the controller (only once per controller)
          // and make sure this is an instance of SocketController

          var Controller = require(controllerFilePath);
          if (!(Controller.prototype instanceof openVeoApi.controllers.SocketController))
            throw new TypeError(controllerFilePath + &#x27; is not a SocketController&#x27;);

          controllerInstance = new Controller(namespace);

          // Save controller instance into cache
          controllers[controllerFilePath] = controllerInstance;
        }

        // Got a method to call on the controller
        if (controllerInstance[actionChunks[1]]) {
          messages[message] = controllerInstance[actionChunks[1]].bind(controllerInstance);
          process.logger.debug(&#x27;Socket message &quot;&#x27; + message + &#x27;&quot; handler attached&#x27;);
        } else {
          process.logger.warn(&#x27;Action for socket message &quot;&#x27; + message + &#x27;&quot; is not valid&#x27;, {
            action: &#x27;addHandlers&#x27;
          });
        }
      } catch (error) {
        process.logger.warn(&#x27;Error while attaching handler for socket message &quot;&#x27; + message + &#x27;&quot;&#x27;, {
          action: &#x27;addHandlers&#x27;,
          error: error.message,
          stack: error.stack
        });
      }

    }
  }
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
